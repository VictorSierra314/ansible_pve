---
- name: Wait for 10min to have all service running or timeout/failing
  pause:
    minutes: 10

- name: Load service facts
  ansible.builtin.service_facts:

- name: Register services as a list
  set_fact:
    services_list: "{{ ansible_facts.services | dict2items }}"

- name: Enable email notification if any services are in failed state
  set_fact:
    send_service_failed_notification: true
  loop: "{{ services_list }}"
  loop_control:
    label: "{{ item.value.name }}"
  when: item.value.state == "failed"

- name: Email notification when services are in failed state
  mail:
    from: "{{ notification_sender }}"
    to: "{{ notification_email }}"
    host: "{{ smtp_host }}"
    port: "{{ smtp_port }}"
    username: "{{ smtp_user | default(omit) }}"
    password: "{{ smtp_password | default(omit) }}"
    attach: "{{ ansible_log.files[0].path | default(omit) }}"
    subject: "PVE VM Upgrade - ERROR - {{ inventory_hostname }} has services in FAILED state"
    body: |
      ---------------------------
      {{ inventory_hostname }} - Post upgrade check FAILED
      ---------------------------
      Some services are in FAILED state following up {{ inventory_hostname }} upgrade.
      Date: {{ ansible_date_time.date }}
      Time: {{ ansible_date_time.time }} {{ ansible_date_time.tz }}
      Services:
      {% for item in services_list %}
      {% if item.value.state == 'failed' %}
      - Service Name: {{ item.key }}, Service State: {{ item.value.state }}
      {% endif %}
      {% endfor %}
  delegate_to: localhost
  when:
    - send_service_failed_notification is defined
    - send_service_failed_notification 
