---
# tasks file for pve_vm_patching
- name: Snapshot host before update
  include_tasks: 1_snapshot_host.yml
  when: enable_snapshot|default('true')|bool

- name: Update podman images
  include_tasks: 2_podman_images_update.yml
  when: update_podman_images|default('false')|bool

- name: Patch all OS
  include_tasks: 3_os_patching.yml
  when:
    - inventory_hostname not in groups['satellite_server_group']
    - inventory_hostname not in groups['satellite_capsule_group']

- name: Patch Satellites capsules instances
  include_tasks: 4_satellite_patching.yml 
  when: inventory_hostname in groups['satellite_capsule_group']

- name: Patch Satellites server instances
  include_tasks: 4_satellite_patching.yml 
  when: inventory_hostname not in groups['satellite_server_group']

- name: Check if a reboot is necessary
  include_tasks: 5_reboot_check.yml
  when:
    - rhel_patch_out.changed is defined
    - rhel_patch_out.changed
    - enable_reboot|default('true')|bool

- name: Clean previous kernels
  include_tasks: 6_kernel_cleanup.yml
  when: 
    - enable_kernel_cleanup|bool
    - ansible_os_family == 'RedHat'
    - new_kernel is defined
    - new_kernel.changed
    - inventory_hostname not in groups['satellite_server_group']
    - inventory_hostname not in groups['satellite_capsule_group']

- name: Clean leaf packages
  include_tasks: 7_leaf_packages_cleanup.yml 
  when: 
    - new_kernel is defined
    - new_kernel.changed

- name: Post update service check
  include_tasks: 8_postupdate_service_check.yml
  when: 
    - inventory_hostname not in service_check_exceptions
    - rhel_patch_out.changed is defined
    - rhel_patch_out.changed

- name: Update Redhat insight
  shell: 'insights-client'
  when: 
    - rhel_patch_out.changed
    - force_insight_refresh is defined
    - ansible_distribution == 'RedHat'

- name: Email report
  mail:
    from: "{{ notification_sender }}"
    to: "{{ notification_email }}"
    host: "{{ smtp_host }}"
    port: "{{ smtp_port }}"
    username: "{{ smtp_user | default(omit) }}"
    password: "{{ smtp_password | default(omit) }}"
    attach: "{{ ansible_log.files[0].path | default(omit) }}"
    subject: "PVE VM Upgrade - REPORT"
    body: |
      ---------------------------
      VM Upgrade final REPORT
      ---------------------------
      Date: {{ ansible_date_time.date }}
      Run at: {{ ansible_date_time.time }} {{ ansible_date_time.tz }}
      {% if ansible_log.files[0].path is defined %}
      Log: {{ ansible_log.files[0].path }}
      {% endif %}
      ---------------------------
      Servers list:
      {% for i in ansible_play_batch and ansible_os_family == 'RedHat' %}
        - {{ i }}, Patched: {% if hostvars[i]['rhel_patch_out']['changed'] is defined and hostvars[i]['rhel_patch_out']['changed'] %}YES{% else %}NO{% endif %}, Rebooted: {% if hostvars[i]['new_kernel'] is defined %}YES{% else %}NO{% endif %} 
      {% endfor %}
      {% for j in ansible_play_batch and ansible_os_family == 'Debian' %}
        - {{ j }}, Patched: {% if hostvars[j]['deb_patch_out']['changed'] is defined and hostvars[j]['deb_patch_out']['changed'] %}YES{% else %}NO{% endif %}, Rebooted: {% if hostvars[j]['new_kernel'] is defined %}YES{% else %}NO{% endif %} 
      {% endfor %}

      ERRORS, if there are any, will be listed bellow:
      {% for i in ansible_play_hosts_all %}
      {% if hostvars[i]['vm_info'] is defined and hostvars[i]['vm_info'].failed is defined and hostvars[i]['vm_info'].failed|bool %}
      {{ i }} - Could not find the host in VMWare, snapshot not taken
      {% endif %}
      {% if hostvars[i]['create_snap'] is defined and hostvars[i]['create_snap'].failed is defined and hostvars[i]['create_snap'].failed|bool %}
      {{ i }} - Snapshot error, VM was not patched
      {% endif %}
      {% if hostvars[i]['rhel_patch_out'] is defined and hostvars[i]['rhel_patch_out'].failed is defined and hostvars[i]['rhel_patch_out'].failed|bool %}
      {{ i }} - Patching error
      {% endif %}
      {% if hostvars[i]['deb_patch_out'] is defined and hostvars[i]['deb_patch_out'].failed is defined and hostvars[i]['deb_patch_out'].failed|bool %}
      {{ i }} - Patching error
      {% endif %}
      {% if hostvars[i]['new_kernel'] is defined and hostvars[i]['new_kernel'].failed is defined and hostvars[i]['new_kernel'].failed|bool %}
      {{ i }} - Reboot task failed, host is either stuck or took longer than 10min to reboot
      {% endif %}
      {% if hostvars[i]['autorm_out'] is defined and hostvars[i]['autorm_out'].failed is defined and hostvars[i]['autorm_out'].failed|bool %}
      {{ i }} - Leaf packages removal error
      {% endif %}
      {% endfor %}
  run_once: true
  delegate_to: localhost
  when: enable_report|default('true')|bool
